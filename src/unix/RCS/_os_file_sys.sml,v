head	1.7;
access;
symbols
	MLW_daveb_inline_1_4_99:1.7.1
	MLWorks_21c0_1999_03_25:1.7
	MLWorks_20c1_1998_08_20:1.6
	MLWorks_20c0_1998_08_04:1.5
	MLWorks_20b2c2_1998_06_19:1.5
	MLWorks_20b2_Windows_1998_06_12:1.5
	MLWorks_20b1c1_1998_05_07:1.5
	MLWorks_20b0_1998_04_07:1.5
	MLWorks_20b0_1998_03_20:1.5
	MLWorks_20m2_1998_02_16:1.5
	MLWorks_20m1_1997_10_23:1.5
	MLWorks_11r1:1.4.5.1.1.1.1
	MLWorks_workspace_97:1.5.2
	MLWorks_dt_wizard:1.5.1
	MLWorks_11c0_1997_09_09:1.4.5.1.1.1
	MLWorks_10r3:1.4.5.1.3
	MLWorks_10r2_551:1.4.5.1.2
	MLWorks_11:1.4.5.1.1
	MLWorks_1_0_r2c2_1997_07_28:1.4.5.1
	MLWorks_20m0_1997_06_20:1.5
	MLWorks_1_0_r2c2_1997_06_14:1.4.5.1
	MLWorks_1_0_r2c1_released_1997_05_23:1.4.5.1
	MLWorks_1_0_r2c1_1997_05_12:1.4.5
	MLWorks_BugFix_1997_04_24:1.4
	MLWorks_1_0_r2_Win32_1997_04_11:1.4
	MLWorks_1_0_r2_Unix_1997_04_04:1.4
	MLWorks_1_0_1_ULTRASPARC_1997_02_24:1.4.3.1.1
	MLWorks_gui_1996_12_18:1.4.4
	MLWorks_1_0_Win32_1996_12_17:1.4.3
	MLWorks_1_0_Irix_1996_11_28_released_1996_12_17:1.4.1.1.1.1
	MLWorks_1_0_Unix_1996_11_14_released_1996_12_17:1.4.1.1
	MLWorks_1_0_Irix_1996_11_28:1.4.1.1.1
	MLWorks_1_0_Win32_1996_11_22:1.4.2
	MLWorks_1_0_Unix_1996_11_14:1.4.1
	MLWorks_Open_Beta2_1996_10_11:1.3.3
	MLWorks_License_dev:1.3.2
	MLWorks_1_open_beta_1996_09_13:1.3.1
	MLWorks_Open_Beta_1996_08_22:1.3
	MLWorks_Beta_1996_07_02:1.2
	MLWorks_Beta_1996_06_07:1.2
	MLWorks_Beta_1996_06_06:1.2
	MLWorks_Beta_1996_06_05:1.2
	MLWorks_Beta_1996_06_03:1.2
	MLWorks_Beta_1996_05_31:1.2
	MLWorks_Beta_1996_05_30:1.2;
locks; strict;
comment	@ *  @;


1.7
date	99.02.02.16.01.58;	author mitchell;	state Exp;
branches
	1.7.1.1;
next	1.6;

1.6
date	98.08.13.10.23.27;	author jont;	state Exp;
branches;
next	1.5;

1.5
date	97.05.27.13.34.21;	author jkbrook;	state Exp;
branches
	1.5.1.1
	1.5.2.1;
next	1.4;

1.4
date	96.10.21.15.23.08;	author jont;	state Exp;
branches
	1.4.1.1
	1.4.2.1
	1.4.3.1
	1.4.4.1
	1.4.5.1;
next	1.3;

1.3
date	96.07.25.12.00.25;	author stephenb;	state Exp;
branches
	1.3.1.1
	1.3.2.1
	1.3.3.1;
next	1.2;

1.2
date	96.05.23.12.02.37;	author stephenb;	state Exp;
branches;
next	1.1;

1.1
date	96.05.17.09.27.21;	author stephenb;	state Exp;
branches;
next	;

1.3.1.1
date	96.09.13.11.42.45;	author hope;	state Exp;
branches;
next	;

1.3.2.1
date	96.10.07.16.35.53;	author hope;	state Exp;
branches;
next	;

1.3.3.1
date	96.10.17.11.54.58;	author hope;	state Exp;
branches;
next	;

1.4.1.1
date	96.11.14.13.23.20;	author hope;	state Exp;
branches
	1.4.1.1.1.1;
next	;

1.4.1.1.1.1
date	96.11.28.15.33.51;	author hope;	state Exp;
branches;
next	;

1.4.2.1
date	96.11.22.18.40.21;	author hope;	state Exp;
branches;
next	;

1.4.3.1
date	96.12.17.18.19.21;	author hope;	state Exp;
branches
	1.4.3.1.1.1;
next	;

1.4.3.1.1.1
date	97.02.24.12.13.42;	author hope;	state Exp;
branches;
next	;

1.4.4.1
date	96.12.18.10.14.45;	author hope;	state Exp;
branches;
next	;

1.4.5.1
date	97.05.12.10.52.55;	author hope;	state Exp;
branches
	1.4.5.1.1.1
	1.4.5.1.2.1
	1.4.5.1.3.1;
next	;

1.4.5.1.1.1
date	97.07.28.18.35.11;	author daveb;	state Exp;
branches
	1.4.5.1.1.1.1.1;
next	;

1.4.5.1.1.1.1.1
date	97.10.07.12.00.50;	author jkbrook;	state Exp;
branches;
next	;

1.4.5.1.2.1
date	97.09.08.17.27.53;	author daveb;	state Exp;
branches;
next	;

1.4.5.1.3.1
date	97.09.09.14.25.03;	author daveb;	state Exp;
branches;
next	;

1.5.1.1
date	97.09.10.19.43.50;	author brucem;	state Exp;
branches;
next	;

1.5.2.1
date	97.09.11.21.11.15;	author daveb;	state Exp;
branches;
next	;

1.7.1.1
date	99.04.01.18.09.20;	author daveb;	state Exp;
branches;
next	;


desc
@new unit
Renamed from _os_filesys inline with latest file name conventions.
@


1.7
log
@[Bug #190500]
Remove redundant require statements
@
text
@(* Copyright Harlequin Ltd. 1994.
 *
 * $Log: _os_file_sys.sml,v $
 *  Revision 1.6  1998/08/13  10:23:27  jont
 *  [Bug #30468]
 *  Change types of mkAbsolute and mkRelative to uses records with names fields
 *
 *  Revision 1.5  1997/05/27  13:34:21  jkbrook
 *  [Bug #01749]
 *  Use __sys_word for SysWord structure
 *
 *  Revision 1.4  1996/10/21  15:23:08  jont
 *  Remove references to basis.toplevel
 *
 *  Revision 1.3  1996/07/25  12:00:25  stephenb
 *  [Bug #1495]
 *  Changed isLink to use lstat instead of stat so that the details
 *  of the link are found and not the linked to file.
 *
 *  Revision 1.2  1996/05/23  12:02:37  stephenb
 *  Implement realPath.
 *
 *  Revision 1.1  1996/05/17  09:27:21  stephenb
 *  new unit
 *  Renamed from _os_filesys inline with latest file name conventions.
 *
 * Revision 1.12  1996/05/16  14:10:01  stephenb
 * Add various missing items to bring it closer to the basis definition.
 *
 * Revision 1.11  1996/05/08  12:15:31  stephenb
 * Rename filesys to be os_filesys in line with latest file naming conventions.
 *
 * Revision 1.10  1996/05/03  15:35:19  stephenb
 * Add some more functions to bring it closer to the latest basis definition.
 * Also updated wrt to continuing POSIXification of the UnixOS structure.
 *
 * Revision 1.9  1996/04/18  15:24:22  jont
 * initbasis moves to basis
 *
 * Revision 1.8  1996/04/01  11:01:10  stephenb
 * Update wrt to Unix->SysErr exception name change.
 *
 * Revision 1.7  1996/03/12  14:50:57  matthew
 * Adding chDir and getDir
 *
 * Revision 1.6  1996/01/18  09:50:02  stephenb
 * OS reorganisation: parameterise functor with UnixOS now that
 * OS specific stuff is no longer in the pervasive library.
 *
 * Revision 1.5  1995/12/04  16:28:01  matthew
 * Adding directory functions
 *
 * Revision 1.4  1995/04/21  16:36:25  daveb
 * Removed BadHomeName exception.
 *
 * Revision 1.3  1995/04/20  17:31:33  daveb
 * Renamed functions to match initial basis, and moved expansion of
 * home dirs to getenv.sml.
 *
 * Revision 1.2  1995/04/12  13:29:16  jont
 * Change FILESYS to FILE_SYS
 *
 * Revision 1.1  1995/01/25  17:17:16  daveb
 * new unit
 * The OS.FileSys structure from the basis.
 *
 *)

require "^.basis.os_path";
require "^.basis.os_file_sys";
require "^.basis.__word";
require "^.basis.__sys_word";
require "unixos";

functor OSFileSys 
  (structure UnixOS: UNIXOS
   structure Path : OS_PATH): OS_FILE_SYS =
struct
  val env = MLWorks.Internal.Runtime.environment

  open UnixOS.FileSys

  val openDir = opendir
  val readDir = readdir
  val rewindDir = rewinddir
  val closeDir = closedir
  val chDir = chdir
  val getDir = getcwd

  fun mkDir pathname = mkdir (pathname, S.irwxo)

  val rmDir = rmdir

  val isDir = ST.isDir o stat
  val isLink = ST.isLink o lstat


  val readLink = readlink


  val fullPath : string -> string = env "OS.FileSys.fullPath"


  (* This is just the same implementation as given in the Mar 1996 basis
   * document except for the fact that Path is not caught as per the 
   * change described in the 19th April 1996 email to the basis group.
   *)
  fun realPath p = 
    if Path.isAbsolute p
    then fullPath p
    else Path.mkRelative {path=fullPath p, relativeTo=fullPath (getDir ())}


  val modTime = ST.mtime o stat


  val fileSize = ST.size o stat


  fun setTime (fileName, NONE) =
     utime (fileName, NONE)
  |   setTime (fileName, SOME time) = 
     utime (fileName, SOME {actime= time, modtime= time})
  

  val remove = unlink


  val tmpName : unit -> string = env "OS.FileSys.tmpName"



  datatype file_id = FILE_ID of dev * ino


  fun fileId s =
    let
      val fileInfo = stat s
    in
      FILE_ID (ST.dev fileInfo, ST.ino fileInfo)
    end


  (* XXX: Replace by a better hash function *)
  fun hash (FILE_ID (dev, ino)) = 
    let
      val devW= devToWord dev
      val inoW= inoToWord ino
    in
      Word.fromLargeWord (SysWord.* (devW, inoW))
    end


  fun compare (FILE_ID (devA, inoA), FILE_ID (devB, inoB)) = 
    let
      val devAW = devToWord devA
      val devBW = devToWord devB
    in
      if devAW < devBW then
        LESS
      else if devAW > devBW then
        GREATER
      else
        let
          val inoAW = inoToWord inoA
          val inoBW = inoToWord inoB
         in
           if inoAW < inoBW then
             LESS
          else if inoAW > inoBW then
             GREATER
          else
            EQUAL
         end
    end
end
@


1.7.1.1
log
@branched from trunk for label MLW_daveb_inline_1_4_99
@
text
@a3 4
 *  Revision 1.7  1999/02/02  16:01:58  mitchell
 *  [Bug #190500]
 *  Remove redundant require statements
 *
@


1.6
log
@[Bug #30468]
Change types of mkAbsolute and mkRelative to uses records with names fields
@
text
@d4 4
a71 1
require "^.basis.__word32";
a72 2
require "^.basis.__position";
require "__time";
@


1.5
log
@[Bug #01749]
Use __sys_word for SysWord structure
@
text
@d4 4
d110 1
a110 1
    else Path.mkRelative (fullPath p, fullPath (getDir ()))
@


1.5.2.1
log
@branched from trunk for label MLWorks_workspace_97
@
text
@a3 4
 *  Revision 1.5  1997/05/27  13:34:21  jkbrook
 *  [Bug #01749]
 *  Use __sys_word for SysWord structure
 *
@


1.5.1.1
log
@branched from trunk for label MLWorks_dt_wizard
@
text
@a3 4
 *  Revision 1.5  1997/05/27  13:34:21  jkbrook
 *  [Bug #01749]
 *  Use __sys_word for SysWord structure
 *
@


1.4
log
@Remove references to basis.toplevel
@
text
@d4 3
d65 1
@


1.4.5.1
log
@branched from 1.4
@
text
@a3 3
 *  Revision 1.4  1996/10/21  15:23:08  jont
 *  Remove references to basis.toplevel
 *
@


1.4.5.1.3.1
log
@branched from MLWorks_1_0_r2c1_1997_05_12 for label MLWorks_10r3
@
text
@a3 3
 *  Revision 1.4.5.1  1997/05/12  10:52:55  hope
 *  branched from 1.4
 *
@


1.4.5.1.2.1
log
@branched from MLWorks_1_0_r2c1_1997_05_12 for label MLWorks_10r2_551
@
text
@a3 3
 *  Revision 1.4.5.1  1997/05/12  10:52:55  hope
 *  branched from 1.4
 *
@


1.4.5.1.1.1
log
@branched from MLWorks_1_0_r2c1_1997_05_12 for label MLWorks_11
@
text
@a3 3
 *  Revision 1.4.5.1  1997/05/12  10:52:55  hope
 *  branched from 1.4
 *
@


1.4.5.1.1.1.1.1
log
@branched from MLWorks_11 for label MLWorks_11r1
@
text
@a3 3
 *  Revision 1.4.5.1.1.1  1997/07/28  18:35:11  daveb
 *  branched from MLWorks_1_0_r2c1_1997_05_12 for label MLWorks_11
 *
@


1.4.4.1
log
@branched from 1.4
@
text
@a3 3
 *  Revision 1.4  1996/10/21  15:23:08  jont
 *  Remove references to basis.toplevel
 *
@


1.4.3.1
log
@branched from 1.4
@
text
@a3 3
 *  Revision 1.4  1996/10/21  15:23:08  jont
 *  Remove references to basis.toplevel
 *
@


1.4.3.1.1.1
log
@branched from 1.4.3.1
@
text
@a3 3
 *  Revision 1.4.3.1  1996/12/17  18:19:21  hope
 *  branched from 1.4
 *
@


1.4.2.1
log
@branched from 1.4
@
text
@a3 3
 *  Revision 1.4  1996/10/21  15:23:08  jont
 *  Remove references to basis.toplevel
 *
@


1.4.1.1
log
@branched from 1.4
@
text
@a3 3
 *  Revision 1.4  1996/10/21  15:23:08  jont
 *  Remove references to basis.toplevel
 *
@


1.4.1.1.1.1
log
@branched from 1.4.1.1
@
text
@a3 3
 *  Revision 1.4.1.1  1996/11/14  13:23:20  hope
 *  branched from 1.4
 *
@


1.3
log
@[Bug #1495]
Changed isLink to use lstat instead of stat so that the details
of the link are found and not the linked to file.
@
text
@d4 5
a57 1
require "^.basis.toplevel";
@


1.3.3.1
log
@branched from 1.3
@
text
@a3 5
 *  Revision 1.3  1996/07/25  12:00:25  stephenb
 *  [Bug #1495]
 *  Changed isLink to use lstat instead of stat so that the details
 *  of the link are found and not the linked to file.
 *
@


1.3.2.1
log
@branched from 1.3
@
text
@a3 5
 *  Revision 1.3  1996/07/25  12:00:25  stephenb
 *  [Bug #1495]
 *  Changed isLink to use lstat instead of stat so that the details
 *  of the link are found and not the linked to file.
 *
@


1.3.1.1
log
@branched from 1.3
@
text
@a3 5
 *  Revision 1.3  1996/07/25  12:00:25  stephenb
 *  [Bug #1495]
 *  Changed isLink to use lstat instead of stat so that the details
 *  of the link are found and not the linked to file.
 *
@


1.2
log
@Implement realPath.
@
text
@d4 3
d82 1
a82 1
  val isLink = ST.isLink o stat
@


1.1
log
@new unit
Renamed from _os_filesys inline with latest file name conventions.
@
text
@d3 5
a7 1
 * $Log: _unixfilesys.sml,v $
d51 1
d59 3
a61 1
functor OSFileSys (structure UnixOS: UNIXOS): OS_FILE_SYS =
d88 3
a90 4
  (* XXX: wrong but will have to do for now.
   * When this is finally changed, make sure that you examine any
   * existing calls to realPath to see if they should be changed to
   * fullPath -- most will
d92 4
a95 1
  val realPath = fullPath
@
